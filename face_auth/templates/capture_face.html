{% extends "base.html" %}
{% block title %}Face Capture{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4>Face Capture</h4>
        <p>Look into the camera and click capture.</p>

        <!-- Webcam -->
        <video id="video" width="480" height="360" autoplay class="border"></video>
        <canvas id="canvas" width="480" height="360" style="display:none;"></canvas>

        <div class="mt-3">
          <button id="captureBtn" class="btn btn-success">Capture & Submit</button>
        </div>
        <div id="status" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Start webcam
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => { document.getElementById("video").srcObject = stream; })
  .catch(err => { document.getElementById("status").innerHTML = "Camera error: " + err; });

document.getElementById("captureBtn").onclick = async () => {
  let video = document.getElementById("video");
  let canvas = document.getElementById("canvas");
  let ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  let dataUrl = canvas.toDataURL("image/jpeg");  // base64

  // send to Flask
  let resp = await fetch("{{ url_for('upload_face') }}", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      image: dataUrl,
      purpose: "{{ purpose }}",
      reg_id: "{{ reg_id }}",
      role: "{{ role }}"
    })
  });

  let res = await resp.json();
  if (res.success) {
    document.getElementById("status").innerHTML =
      "<div class='alert alert-success'>" + res.message + "</div>";
    window.location.href = res.redirect;
  } else {
    document.getElementById("status").innerHTML =
      "<div class='alert alert-danger'>" + res.error + "</div>";
  }
};
</script>
{% endblock %}
